<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_441902_task_ac.TaskCounter</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>This script include manages all the server logic for the Task Counter functionality.&#13;
&#13;
You can initialize this object without any parameters, and then use the following methods:&#13;
&#13;
var Counter = new TaskCounter();&#13;
counter.setUser(GlideRecord);&#13;
&#13;
var Counter = new TaskCounter(GlideRecord);&#13;
&#13;
If you do not specify any parameters the isBatch will be the default type.&#13;
&#13;
Once you've set the user, you can then call the method:&#13;
counter.getTotalByAssignee();&#13;
&#13;
If you have not set the user, you can then call the method:&#13;
 counter.getTotalForAll();</description>
        <name>TaskCounter</name>
        <script><![CDATA[var TaskCounter = Class.create();

// *********************************************************************************
// INTERNAL API
// *********************************************************************************

var TABLES = {
	TASK: "task",
	USER: "sys_user"
};

var PROPS = {
	PAYLOAD_MAP: "x_441902_task_ac.payload.mapping",
	ENABLED: "x_441902_task_ac.enable"
};

var FIELDS = {
	RAW_PAYLOAD: "x_441902_task_ac_raw_assignment_payload",
	SUMMARY: "x_441902_task_ac_task_assignment_summary",
	ASSIGNED_TO: "assigned_to"
};

var USER_QUERY = "roles=itil^active=true^NQx_441902_task_ac_raw_assignment_payloadISNOTEMPTY";

var isValidGR = function (obj, table) {
	if (obj && table && (obj instanceof GlideRecord)) {
		if (obj.getTableName() === table) {
			return obj.isValidRecord();
		}
	}
	return false;
};

var getAllUsers = function () {
	var users = new GlideRecord(TABLES.USER);
	users.addEncodedQuery(USER_QUERY);
	users.query();
	return users;
};

var isEnabled = function () {
	return (gs.getProperty(PROPS.ENABLED, "false") === "true")
		? true 
		: false;
};

var isAttributeValid = function (obj, attr) {
	if (!obj || !attr) {
		return false;
	}
	if (Object.keys(obj).indexOf(attr) > -1) {
		return true;
	}
	return false;
};

var isValidTable = function (table) {
	var propValue = gs.getProperty(PROPS.PAYLOAD_MAP);
	if (!propValue || !table) {
		return false;
	}
	return isAttributeValid(JSON.parse(propValue), table);
};

var getListTables = function () {
	var propValue = gs.getProperty(PROPS.PAYLOAD_MAP);
	if (!propValue) {
		return [];
	}
	return Object.keys(JSON.parse(propValue));
};

var resetFields = function () {
	var users = getAllUsers();
	while (users.next()) {
		users.setValue(FIELDS.RAW_PAYLOAD, "");
		users.setValue(FIELDS.SUMMARY, "");
		users.update();
	}
};

// *********************************************************************************
// EXTERNAL API
// *********************************************************************************

TaskCounter.isEnabled = isEnabled;
TaskCounter.isValidTable = isValidTable;
TaskCounter.resetFields = resetFields;

TaskCounter.PROPS = PROPS;
TaskCounter.FIELDS = FIELDS;

TaskCounter.prototype = {
	
    /* 
     * We initiate all the necessary attributes throw an exception if the userRecord is invalid
	 *
     * @author Lucas Rivetti Guerino
     *
	 * @parm userRecord (GlideRecord): Valid GlideRecord poiting to the sys_user table
     * @return (void)
     */
	initialize: function (userRecord) {
		
		if (!userRecord) {
			this.setBatch(true);
			return;
		}
		
		this.setUser(userRecord);

		if (getListTables().length === 0) {
			throw new Error (
				"[" + this.type + "] - [initialize] - " +
				"The property [" + PROPS.PAYLOAD_MAP + "] does not have any table specified. " +
				"Please follow the instructions on the property description."
			);
		}
	},

	setUser: function (value) {
		this.setBatch(false);
		if (isValidGR(value, TABLES.USER)) {
			this.user = value;
			return;
		}
		throw new Error(
			"[" + this.type + "] - [setUser] - Unable to set user as a GlideRecord object"
		);
	},

    setBatch: function (value) {
        this.isBatch = value;
    },

	/* 
	 * Counts the number of tasks assigned to a given user
	 *
     * @author Lucas Rivetti Guerino
     *
     * @return (Stringified JSON)
	   The user sys id is the parent oject and the table names are attributes of the parent object
		{
			"681b365ec0a80164000fb0b05854a0cd": {
				"change_request": "5",
				"incident": "17",
				"incident_alert_task": "9",
				"problem": "9"
			}
		}
     */
	getTotalByAssignee: function () {
		try {
			var output = {};
			var tasks = new GlideAggregate(TABLES.TASK);
			tasks.addAggregate("COUNT", FIELDS.ASSIGNED_TO);
			tasks.addQuery("assigned_to", this.user.getUniqueValue());
			tasks.addNotNullQuery(FIELDS.ASSIGNED_TO);
			tasks.addQuery("active", true);
			tasks.addQuery("sys_class_name", "IN", getListTables());
			tasks.groupBy("sys_class_name");
			tasks.query();
			output[this.user.getUniqueValue()] = {};
			while (tasks.next()) {
				output[this.user.getUniqueValue()][tasks.getValue("sys_class_name")] = {};
				output[this.user.getUniqueValue()][tasks.getValue("sys_class_name")] = tasks.getAggregate("COUNT", FIELDS.ASSIGNED_TO);
			}
			return JSON.stringify(output);
		} catch (error) {
			throw new Error(
				"[" + this.type + "] - [getTotalByAssignee] - [Runtime error]/n" + error
			);
		}
	},
	
	getTotalForAll: function () {
		var arrayOutput = [];
		var output = {};
		var users = getAllUsers();
		if (!users.hasNext()) {
			gs.warn(
				"[" + this.type + "] - [getTotalForAll] - " +
				"No users found by running query:\n" + users.getEncodedQuery()
			);
			return;
		}
		while (users.next()) {
			try {
				this.setUser(users);
				output = JSON.parse(this.getTotalByAssignee());
				// We ignore objects that do not have any attributes.
				// The attributes of these objects are the name of the task tables
				// If the user is not assigned to any of these tables then we don't want to return
				if (Object.keys(output[this.user.getUniqueValue()]).length === 0) {
					continue;
				}
				arrayOutput.push(output);
			} catch (error) {
				continue;
			}
		}
		return JSON.stringify(arrayOutput);
	},

    type: "TaskCounter"
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-02-28 13:40:17</sys_created_on>
        <sys_id>ae798df42f9b00107d7d59a72799b6ef</sys_id>
        <sys_mod_count>84</sys_mod_count>
        <sys_name>TaskCounter</sys_name>
        <sys_package display_value="Task Assignment Counter " source="x_441902_task_ac">19d84d382f9b00107d7d59a72799b652</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Task Assignment Counter ">19d84d382f9b00107d7d59a72799b652</sys_scope>
        <sys_update_name>sys_script_include_ae798df42f9b00107d7d59a72799b6ef</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-03-04 14:34:15</sys_updated_on>
    </sys_script_include>
</record_update>
